<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.LunchGo.review.mapper.ReviewReadMapper">

    <select id="selectReviewSummary" parameterType="long" resultType="com.example.LunchGo.review.dto.ReviewSummary">
        SELECT
            COALESCE(AVG(r.rating), 0) AS avgRating,
            COUNT(*) AS reviewCount
        FROM reviews r
        WHERE r.restaurant_id = #{restaurantId}
          AND r.status IN ('PUBLIC', 'BLINDED')
    </select>

    <select id="selectTopTags" parameterType="long" resultType="com.example.LunchGo.review.dto.TagCount">
        SELECT
            t.tag_id AS tagId,
            t.name AS name,
            COUNT(*) AS count
        FROM review_tag_maps m
        JOIN review_tags t ON t.tag_id = m.tag_id
        JOIN reviews r ON r.review_id = m.review_id
        WHERE r.restaurant_id = #{restaurantId}
          AND r.status IN ('PUBLIC', 'BLINDED')
        GROUP BY t.tag_id, t.name
        ORDER BY count DESC
        LIMIT 3
    </select>

    <select id="selectReviewCount" parameterType="com.example.LunchGo.review.dto.ReviewListQuery" resultType="long">
        SELECT COUNT(DISTINCT r.review_id)
        FROM reviews r
        <if test="tagIds != null and tagIds.size() &gt; 0">
            JOIN review_tag_maps m ON m.review_id = r.review_id
        </if>
        WHERE r.restaurant_id = #{restaurantId}
          AND r.status IN ('PUBLIC', 'BLINDED')
          <if test="tagIds != null and tagIds.size() &gt; 0">
            AND m.tag_id IN
            <foreach collection="tagIds" item="tagId" open="(" separator="," close=")">
                #{tagId}
            </foreach>
          </if>
    </select>

    <select id="selectReviewItems" parameterType="com.example.LunchGo.review.dto.ReviewListQuery" resultType="com.example.LunchGo.review.dto.ReviewItemResponse">
        SELECT DISTINCT
            r.review_id AS reviewId,
            CONCAT(LEFT(u.name, 1), '**') AS author,
            u.company_name AS company,
            rus.visit_cnt AS visitCount,
            r.rating AS rating,
            r.content AS content,
            DATE(r.created_at) AS createdAt,
            r.created_at AS createdAtTs,
            r.status AS status,
            CASE WHEN r.status = 'BLINDED' THEN 1 ELSE 0 END AS isBlinded,
            NULL AS blindReason
        FROM reviews r
        JOIN users u ON u.user_id = r.user_id
        LEFT JOIN restaurant_user_stats rus
            ON rus.restaurant_id = r.restaurant_id
           AND rus.user_id = r.user_id
        <if test="tagIds != null and tagIds.size() &gt; 0">
            JOIN review_tag_maps m ON m.review_id = r.review_id
        </if>
        WHERE r.restaurant_id = #{restaurantId}
          AND r.status IN ('PUBLIC', 'BLINDED')
          <if test="tagIds != null and tagIds.size() &gt; 0">
            AND m.tag_id IN
            <foreach collection="tagIds" item="tagId" open="(" separator="," close=")">
                #{tagId}
            </foreach>
          </if>
        <choose>
            <when test="sort != null and sort.name() == 'LATEST'">
                ORDER BY createdAtTs DESC
            </when>
            <when test="sort != null and sort.name() == 'RATING_DESC'">
                ORDER BY r.rating DESC, createdAtTs DESC
            </when>
            <when test="sort != null and sort.name() == 'RATING_ASC'">
                ORDER BY r.rating ASC, createdAtTs DESC
            </when>
            <otherwise>
                ORDER BY createdAtTs DESC
            </otherwise>
        </choose>
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="selectReviewPageIds" parameterType="com.example.LunchGo.review.dto.ReviewListQuery" resultType="long">
        SELECT t.review_id
        FROM (
            SELECT DISTINCT
                r.review_id,
                r.created_at,
                r.rating
            FROM reviews r
            <if test="tagIds != null and tagIds.size() &gt; 0">
                JOIN review_tag_maps m ON m.review_id = r.review_id
            </if>
            WHERE r.restaurant_id = #{restaurantId}
              AND r.status IN ('PUBLIC', 'BLINDED')
              <if test="tagIds != null and tagIds.size() &gt; 0">
                AND m.tag_id IN
                <foreach collection="tagIds" item="tagId" open="(" separator="," close=")">
                    #{tagId}
                </foreach>
              </if>
        ) t
        <choose>
            <when test="sort != null and sort.name() == 'LATEST'">
                ORDER BY t.created_at DESC
            </when>
            <when test="sort != null and sort.name() == 'RATING_DESC'">
                ORDER BY t.rating DESC, t.created_at DESC
            </when>
            <when test="sort != null and sort.name() == 'RATING_ASC'">
                ORDER BY t.rating ASC, t.created_at DESC
            </when>
            <otherwise>
                ORDER BY t.created_at DESC
            </otherwise>
        </choose>
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="selectReviewItemsByIds" resultType="com.example.LunchGo.review.dto.ReviewItemResponse">
        SELECT
            r.review_id AS reviewId,
            CONCAT(LEFT(u.name, 1), '**') AS author,
            u.company_name AS company,
            rus.visit_cnt AS visitCount,
            r.rating AS rating,
            r.content AS content,
            DATE(r.created_at) AS createdAt,
            r.created_at AS createdAtTs,
            r.status AS status,
            CASE WHEN r.status = 'BLINDED' THEN 1 ELSE 0 END AS isBlinded,
            NULL AS blindReason
        FROM reviews r
        JOIN users u ON u.user_id = r.user_id
        LEFT JOIN restaurant_user_stats rus
            ON rus.restaurant_id = r.restaurant_id
           AND rus.user_id = r.user_id
        WHERE r.review_id IN
        <foreach collection="reviewIds" item="reviewId" open="(" separator="," close=")">
            #{reviewId}
        </foreach>
        ORDER BY FIELD(r.review_id,
        <foreach collection="reviewIds" item="reviewId" separator=",">
            #{reviewId}
        </foreach>
        )
    </select>

    <select id="selectReviewDetail" parameterType="long" resultType="com.example.LunchGo.review.dto.ReviewDetailResponse">
        SELECT
            r.review_id AS reviewId,
            CONCAT(LEFT(u.name, 1), '**') AS author,
            u.company_name AS company,
            rus.visit_cnt AS visitCount,
            r.rating AS rating,
            r.content AS content,
            DATE(r.created_at) AS createdAt,
            r.status AS status,
            CASE WHEN r.status = 'BLINDED' THEN 1 ELSE 0 END AS isBlinded,
            NULL AS blindReason
        FROM reviews r
        JOIN users u ON u.user_id = r.user_id
        LEFT JOIN restaurant_user_stats rus
            ON rus.restaurant_id = r.restaurant_id
           AND rus.user_id = r.user_id
        WHERE r.review_id = #{reviewId}
    </select>

    <select id="selectReviewTags" parameterType="long" resultType="com.example.LunchGo.review.dto.TagResponse">
        SELECT
            t.tag_id AS tagId,
            t.name AS name
        FROM review_tag_maps m
        JOIN review_tags t ON t.tag_id = m.tag_id
        WHERE m.review_id = #{reviewId}
        ORDER BY t.tag_id
    </select>

    <select id="selectReviewImages" parameterType="long" resultType="string">
        SELECT
            image_url
        FROM review_images
        WHERE review_id = #{reviewId}
        ORDER BY sort_order ASC
    </select>

    <select id="selectReviewComments" parameterType="long" resultType="com.example.LunchGo.review.dto.CommentResponse">
        SELECT
            c.comment_id AS commentId,
            c.writer_type AS writerType,
            CASE
                WHEN c.writer_type = 'OWNER' THEN res.name
                ELSE 'LunchGo Admin'
            END AS writerName,
            c.content AS content,
            c.created_at AS createdAt
        FROM comments c
        JOIN reviews r ON r.review_id = c.review_id
        JOIN restaurants res ON res.restaurant_id = r.restaurant_id
        WHERE c.review_id = #{reviewId}
        ORDER BY c.created_at ASC
    </select>

    <select id="selectReviewCommentById" parameterType="long" resultType="com.example.LunchGo.review.dto.CommentResponse">
        SELECT
            c.comment_id AS commentId,
            c.writer_type AS writerType,
            CASE
                WHEN c.writer_type = 'OWNER' THEN res.name
                ELSE 'LunchGo Admin'
            END AS writerName,
            c.content AS content,
            c.created_at AS createdAt
        FROM comments c
        JOIN reviews r ON r.review_id = c.review_id
        JOIN restaurants res ON res.restaurant_id = r.restaurant_id
        WHERE c.comment_id = #{commentId}
    </select>

    <select id="selectVisitInfo" parameterType="long" resultType="com.example.LunchGo.review.dto.VisitInfo">
        SELECT
            slot.slot_date AS date,
            rs.party_size AS partySize,
            rc.confirmed_amount AS totalAmount,
            rc.image_url AS receiptImageUrl
        FROM reviews r
        JOIN receipts rc ON rc.receipt_id = r.receipt_id
        JOIN reservations rs ON rs.reservation_id = rc.reservation_id
        JOIN restaurant_reservation_slots slot ON slot.slot_id = rs.slot_id
        WHERE r.review_id = #{reviewId}
    </select>

    <select id="selectReceiptItems" parameterType="long" resultType="com.example.LunchGo.review.dto.ReceiptItemResponse">
        SELECT
            ri.menu_name AS name,
            ri.qty AS qty,
            ri.unit_price AS unitPrice,
            ri.total_price AS totalPrice
        FROM receipt_items ri
        WHERE ri.receipt_id = #{receiptId}
        ORDER BY ri.receipt_item_id ASC
    </select>

    <select id="selectReceiptItemsByReviewId" parameterType="long" resultType="com.example.LunchGo.review.dto.ReceiptItemResponse">
        SELECT
            ri.menu_name AS name,
            ri.qty AS qty,
            ri.unit_price AS unitPrice,
            ri.total_price AS totalPrice
        FROM reviews r
        JOIN receipts rc ON rc.receipt_id = r.receipt_id
        JOIN receipt_items ri ON ri.receipt_id = rc.receipt_id
        WHERE r.review_id = #{reviewId}
        ORDER BY ri.receipt_item_id ASC
    </select>

    <select id="selectReviewTagsByReviewIds" resultType="com.example.LunchGo.review.dto.ReviewTagRow">
        SELECT
            m.review_id AS reviewId,
            t.tag_id AS tagId,
            t.name AS name
        FROM review_tag_maps m
        JOIN review_tags t ON t.tag_id = m.tag_id
        WHERE m.review_id IN
        <foreach collection="reviewIds" item="reviewId" open="(" separator="," close=")">
            #{reviewId}
        </foreach>
        ORDER BY m.review_id, t.tag_id
    </select>

    <select id="selectReviewImagesByReviewIds" resultType="com.example.LunchGo.review.dto.ReviewImageRow">
        SELECT
            review_id AS reviewId,
            image_url AS imageUrl
        FROM review_images
        WHERE review_id IN
        <foreach collection="reviewIds" item="reviewId" open="(" separator="," close=")">
            #{reviewId}
        </foreach>
        ORDER BY review_id, sort_order ASC
    </select>

</mapper>
