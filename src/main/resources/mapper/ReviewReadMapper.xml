<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.LunchGo.review.mapper.ReviewReadMapper">

    <select id="selectReviewSummary" resultType="com.example.LunchGo.review.dto.ReviewSummary">
        SELECT
            COALESCE(AVG(r.rating), 0) AS avgRating,
            COUNT(*) AS reviewCount
        FROM reviews r
        WHERE r.restaurant_id = #{restaurantId}
          <choose>
            <when test="includeBlinded">
              AND r.status IN ('PUBLIC', 'BLINDED', 'BLIND_REQUEST', 'BLIND_REJECTED')
            </when>
            <otherwise>
              AND r.status IN ('PUBLIC', 'BLIND_REQUEST', 'BLIND_REJECTED')
            </otherwise>
          </choose>
    </select>

    <select id="selectTopTags" resultType="com.example.LunchGo.review.dto.TagCount">
        SELECT
            t.tag_id AS tagId,
            t.name AS name,
            COUNT(*) AS count
        FROM review_tag_maps m
        JOIN review_tags t ON t.tag_id = m.tag_id
        JOIN reviews r ON r.review_id = m.review_id
        WHERE r.restaurant_id = #{restaurantId}
          <choose>
            <when test="includeBlinded">
              AND r.status IN ('PUBLIC', 'BLINDED', 'BLIND_REQUEST', 'BLIND_REJECTED')
            </when>
            <otherwise>
              AND r.status IN ('PUBLIC', 'BLIND_REQUEST', 'BLIND_REJECTED')
            </otherwise>
          </choose>
        GROUP BY t.tag_id, t.name
        ORDER BY count DESC
        LIMIT 3
    </select>

    <select id="selectReviewCount" parameterType="com.example.LunchGo.review.dto.ReviewListQuery" resultType="long">
        SELECT COUNT(DISTINCT r.review_id)
        FROM reviews r
        <if test="tagIds != null and tagIds.size() &gt; 0">
            JOIN review_tag_maps m ON m.review_id = r.review_id
        </if>
        WHERE r.restaurant_id = #{restaurantId}
          <choose>
            <when test="includeBlinded">
              AND r.status IN ('PUBLIC', 'BLINDED', 'BLIND_REQUEST', 'BLIND_REJECTED')
            </when>
            <otherwise>
              AND r.status IN ('PUBLIC', 'BLIND_REQUEST', 'BLIND_REJECTED')
            </otherwise>
          </choose>
          <if test="tagIds != null and tagIds.size() &gt; 0">
            AND m.tag_id IN
            <foreach collection="tagIds" item="tagId" open="(" separator="," close=")">
                #{tagId}
            </foreach>
          </if>
    </select>

    <select id="selectReviewItems" parameterType="com.example.LunchGo.review.dto.ReviewListQuery" resultType="com.example.LunchGo.review.dto.ReviewItemResponse">
        SELECT DISTINCT
            r.review_id AS reviewId,
            CASE
                WHEN u.nickname IS NOT NULL AND u.nickname != '' THEN u.nickname
                ELSE CONCAT(LEFT(u.name, 1), '**')
            END AS author,
            u.company_name AS company,
            rus.visit_cnt AS visitCount,
            r.rating AS rating,
            r.content AS content,
            DATE(r.created_at) AS createdAt,
            r.created_at AS createdAtTs,
            r.status AS status,
            CASE WHEN r.status = 'BLINDED' THEN 1 ELSE 0 END AS isBlinded,
            NULL AS blindReason,
          r.blind_request_tag_id AS blindRequestTagId,
          brt.name AS blindRequestTagName,
          r.blind_request_reason AS blindRequestReason,
          r.blind_requested_at AS blindRequestedAt,
          slot.slot_date AS visitDate,
          rs.party_size AS visitPartySize,
          COALESCE(rc.confirmed_amount, rmi.menu_total, rs.total_amount, 0) AS visitTotalAmount,
          COALESCE(c_count.cnt, 0) AS commentCount
        FROM reviews r
        LEFT JOIN receipts rc ON rc.receipt_id = r.receipt_id
        LEFT JOIN reservations rs ON rs.reservation_id = COALESCE(r.reservation_id, rc.reservation_id)
        LEFT JOIN restaurant_reservation_slots slot ON slot.slot_id = rs.slot_id
        LEFT JOIN (
            SELECT reservation_id, SUM(line_amount) AS menu_total
            FROM reservation_menu_items
            GROUP BY reservation_id
        ) rmi ON rmi.reservation_id = rs.reservation_id
        LEFT JOIN (
            SELECT review_id, COUNT(*) AS cnt
            FROM comments
            GROUP BY review_id
        ) c_count ON c_count.review_id = r.review_id
        JOIN users u ON u.user_id = r.user_id
        LEFT JOIN restaurant_user_stats rus
            ON rus.restaurant_id = r.restaurant_id
           AND rus.user_id = r.user_id
        LEFT JOIN review_tags brt ON brt.tag_id = r.blind_request_tag_id
        <if test="tagIds != null and tagIds.size() &gt; 0">
            JOIN review_tag_maps m ON m.review_id = r.review_id
        </if>
        WHERE r.restaurant_id = #{restaurantId}
          <choose>
            <when test="includeBlinded">
              AND r.status IN ('PUBLIC', 'BLINDED', 'BLIND_REQUEST', 'BLIND_REJECTED')
            </when>
            <otherwise>
              AND r.status IN ('PUBLIC', 'BLIND_REQUEST', 'BLIND_REJECTED')
            </otherwise>
          </choose>
          <if test="tagIds != null and tagIds.size() &gt; 0">
            AND m.tag_id IN
            <foreach collection="tagIds" item="tagId" open="(" separator="," close=")">
                #{tagId}
            </foreach>
          </if>
        <choose>
            <when test="sort != null and sort.name() == 'LATEST'">
                ORDER BY createdAtTs DESC
            </when>
            <when test="sort != null and sort.name() == 'RATING_DESC'">
                ORDER BY r.rating DESC, createdAtTs DESC
            </when>
            <when test="sort != null and sort.name() == 'RATING_ASC'">
                ORDER BY r.rating ASC, createdAtTs DESC
            </when>
            <otherwise>
                ORDER BY createdAtTs DESC
            </otherwise>
        </choose>
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="selectReviewItemsPage" parameterType="com.example.LunchGo.review.dto.ReviewListQuery" resultType="com.example.LunchGo.review.dto.ReviewItemResponse">
        SELECT
            r.review_id AS reviewId,
            CASE
                WHEN u.nickname IS NOT NULL AND u.nickname != '' THEN u.nickname
                ELSE CONCAT(LEFT(u.name, 1), '**')
            END AS author,
            u.company_name AS company,
            rus.visit_cnt AS visitCount,
            r.rating AS rating,
            r.content AS content,
            DATE(r.created_at) AS createdAt,
            r.created_at AS createdAtTs,
            r.status AS status,
            CASE WHEN r.status = 'BLINDED' THEN 1 ELSE 0 END AS isBlinded,
            NULL AS blindReason,
            r.blind_request_tag_id AS blindRequestTagId,
            brt.name AS blindRequestTagName,
            r.blind_request_reason AS blindRequestReason,
            r.blind_requested_at AS blindRequestedAt,
            COALESCE(c_count.cnt, 0) AS commentCount
        FROM reviews r
        JOIN (
            SELECT DISTINCT
                r.review_id,
                r.created_at,
                r.rating
            FROM reviews r
            <if test="tagIds != null and tagIds.size() &gt; 0">
                JOIN review_tag_maps m ON m.review_id = r.review_id
            </if>
            WHERE r.restaurant_id = #{restaurantId}
              <choose>
                <when test="includeBlinded">
                  AND r.status IN ('PUBLIC', 'BLINDED', 'BLIND_REQUEST', 'BLIND_REJECTED')
                </when>
                <otherwise>
                  AND r.status IN ('PUBLIC', 'BLIND_REQUEST', 'BLIND_REJECTED')
                </otherwise>
              </choose>
              <if test="tagIds != null and tagIds.size() &gt; 0">
                AND m.tag_id IN
                <foreach collection="tagIds" item="tagId" open="(" separator="," close=")">
                    #{tagId}
                </foreach>
              </if>
            <choose>
                <when test="sort != null and sort.name() == 'LATEST'">
                    ORDER BY r.created_at DESC
                </when>
                <when test="sort != null and sort.name() == 'RATING_DESC'">
                    ORDER BY r.rating DESC, r.created_at DESC
                </when>
                <when test="sort != null and sort.name() == 'RATING_ASC'">
                    ORDER BY r.rating ASC, r.created_at DESC
                </when>
                <otherwise>
                    ORDER BY r.created_at DESC
                </otherwise>
            </choose>
            LIMIT #{size} OFFSET #{offset}
        ) page ON page.review_id = r.review_id
        LEFT JOIN (
            SELECT review_id, COUNT(*) AS cnt
            FROM comments
            GROUP BY review_id
        ) c_count ON c_count.review_id = r.review_id
        JOIN users u ON u.user_id = r.user_id
        LEFT JOIN restaurant_user_stats rus
            ON rus.restaurant_id = r.restaurant_id
           AND rus.user_id = r.user_id
        LEFT JOIN review_tags brt ON brt.tag_id = r.blind_request_tag_id
        <choose>
            <when test="sort != null and sort.name() == 'LATEST'">
                ORDER BY page.created_at DESC
            </when>
            <when test="sort != null and sort.name() == 'RATING_DESC'">
                ORDER BY page.rating DESC, page.created_at DESC
            </when>
            <when test="sort != null and sort.name() == 'RATING_ASC'">
                ORDER BY page.rating ASC, page.created_at DESC
            </when>
            <otherwise>
                ORDER BY page.created_at DESC
            </otherwise>
        </choose>
    </select>

    <select id="selectReviewPageIds" parameterType="com.example.LunchGo.review.dto.ReviewListQuery" resultType="long">
        SELECT t.review_id
        FROM (
            SELECT DISTINCT
                r.review_id,
                r.created_at,
                r.rating
            FROM reviews r
            <if test="tagIds != null and tagIds.size() &gt; 0">
                JOIN review_tag_maps m ON m.review_id = r.review_id
            </if>
            WHERE r.restaurant_id = #{restaurantId}
              <choose>
                <when test="includeBlinded">
                  AND r.status IN ('PUBLIC', 'BLINDED', 'BLIND_REQUEST', 'BLIND_REJECTED')
                </when>
                <otherwise>
                  AND r.status IN ('PUBLIC', 'BLIND_REQUEST', 'BLIND_REJECTED')
                </otherwise>
              </choose>
              <if test="tagIds != null and tagIds.size() &gt; 0">
                AND m.tag_id IN
                <foreach collection="tagIds" item="tagId" open="(" separator="," close=")">
                    #{tagId}
                </foreach>
              </if>
        ) t
        <choose>
            <when test="sort != null and sort.name() == 'LATEST'">
                ORDER BY t.created_at DESC
            </when>
            <when test="sort != null and sort.name() == 'RATING_DESC'">
                ORDER BY t.rating DESC, t.created_at DESC
            </when>
            <when test="sort != null and sort.name() == 'RATING_ASC'">
                ORDER BY t.rating ASC, t.created_at DESC
            </when>
            <otherwise>
                ORDER BY t.created_at DESC
            </otherwise>
        </choose>
        LIMIT #{size} OFFSET #{offset}
    </select>

    <select id="selectReviewItemsByIds" resultType="com.example.LunchGo.review.dto.ReviewItemResponse">
        SELECT
            r.review_id AS reviewId,
            CASE
                WHEN u.nickname IS NOT NULL AND u.nickname != '' THEN u.nickname
                ELSE CONCAT(LEFT(u.name, 1), '**')
            END AS author,
            u.company_name AS company,
            rus.visit_cnt AS visitCount,
            r.rating AS rating,
            r.content AS content,
            DATE(r.created_at) AS createdAt,
            r.created_at AS createdAtTs,
            r.status AS status,
            CASE WHEN r.status = 'BLINDED' THEN 1 ELSE 0 END AS isBlinded,
            NULL AS blindReason,
            r.blind_request_tag_id AS blindRequestTagId,
            brt.name AS blindRequestTagName,
            r.blind_request_reason AS blindRequestReason,
            r.blind_requested_at AS blindRequestedAt
        FROM reviews r
        JOIN users u ON u.user_id = r.user_id
        LEFT JOIN restaurant_user_stats rus
            ON rus.restaurant_id = r.restaurant_id
           AND rus.user_id = r.user_id
        LEFT JOIN review_tags brt ON brt.tag_id = r.blind_request_tag_id
        WHERE r.review_id IN
        <foreach collection="reviewIds" item="reviewId" open="(" separator="," close=")">
            #{reviewId}
        </foreach>
        ORDER BY FIELD(r.review_id,
        <foreach collection="reviewIds" item="reviewId" separator=",">
            #{reviewId}
        </foreach>
        )
    </select>

    <select id="selectReviewDetail" resultType="com.example.LunchGo.review.dto.ReviewDetailResponse">
        SELECT
            r.review_id AS reviewId,
            CASE
                WHEN u.nickname IS NOT NULL AND u.nickname != '' THEN u.nickname
                ELSE CONCAT(LEFT(u.name, 1), '**')
            END AS author,
            u.company_name AS company,
            rus.visit_cnt AS visitCount,
            r.rating AS rating,
            r.content AS content,
            DATE(r.created_at) AS createdAt,
            r.status AS status,
            CASE WHEN r.status = 'BLINDED' THEN 1 ELSE 0 END AS isBlinded,
            NULL AS blindReason,
            r.blind_request_tag_id AS blindRequestTagId,
            brt.name AS blindRequestTagName,
            r.blind_request_reason AS blindRequestReason,
            r.blind_requested_at AS blindRequestedAt
        FROM reviews r
        JOIN users u ON u.user_id = r.user_id
        LEFT JOIN restaurant_user_stats rus
            ON rus.restaurant_id = r.restaurant_id
           AND rus.user_id = r.user_id
        LEFT JOIN review_tags brt ON brt.tag_id = r.blind_request_tag_id
        WHERE r.review_id = #{reviewId}
          <if test="includeBlinded == false">
            AND r.status != 'BLINDED'
          </if>
    </select>

    <select id="selectReviewTags" parameterType="long" resultType="com.example.LunchGo.review.dto.TagResponse">
        SELECT
            t.tag_id AS tagId,
            t.name AS name
        FROM review_tag_maps m
        JOIN review_tags t ON t.tag_id = m.tag_id
        WHERE m.review_id = #{reviewId}
        ORDER BY t.tag_id
    </select>

    <select id="selectReviewImages" parameterType="long" resultType="string">
        SELECT
            image_url
        FROM review_images
        WHERE review_id = #{reviewId}
        ORDER BY sort_order ASC
    </select>

    <select id="selectReviewComments" parameterType="long" resultType="com.example.LunchGo.review.dto.CommentResponse">
        SELECT
            c.comment_id AS commentId,
            c.writer_type AS writerType,
            CASE
                WHEN c.writer_type = 'OWNER' THEN res.name
                ELSE 'LunchGo Admin'
            END AS writerName,
            c.content AS content,
            c.created_at AS createdAt
        FROM comments c
        JOIN reviews r ON r.review_id = c.review_id
        JOIN restaurants res ON res.restaurant_id = r.restaurant_id
        WHERE c.review_id = #{reviewId}
        ORDER BY c.created_at ASC
    </select>

    <select id="selectReviewCommentById" parameterType="long" resultType="com.example.LunchGo.review.dto.CommentResponse">
        SELECT
            c.comment_id AS commentId,
            c.writer_type AS writerType,
            CASE
                WHEN c.writer_type = 'OWNER' THEN res.name
                ELSE 'LunchGo Admin'
            END AS writerName,
            c.content AS content,
            c.created_at AS createdAt
        FROM comments c
        JOIN reviews r ON r.review_id = c.review_id
        JOIN restaurants res ON res.restaurant_id = r.restaurant_id
        WHERE c.comment_id = #{commentId}
    </select>

    <select id="selectVisitInfo" parameterType="long" resultType="com.example.LunchGo.review.dto.VisitInfo">
        SELECT
            slot.slot_date AS date,
            rs.party_size AS partySize,
            COALESCE(rc.confirmed_amount, rmi.menu_total, rs.total_amount) AS totalAmount,
            rc.image_url AS receiptImageUrl
        FROM reviews r
        LEFT JOIN receipts rc ON rc.receipt_id = r.receipt_id
        LEFT JOIN reservations rs ON rs.reservation_id = COALESCE(r.reservation_id, rc.reservation_id)
        LEFT JOIN restaurant_reservation_slots slot ON slot.slot_id = rs.slot_id
        LEFT JOIN (
            SELECT reservation_id, SUM(line_amount) AS menu_total
            FROM reservation_menu_items
            GROUP BY reservation_id
        ) rmi ON rmi.reservation_id = rs.reservation_id
        WHERE r.review_id = #{reviewId}
    </select>

    <select id="selectReceiptItems" parameterType="long" resultType="com.example.LunchGo.review.dto.ReceiptItemResponse">
        SELECT
            ri.menu_name COLLATE utf8mb4_general_ci AS name,
            ri.qty AS qty,
            ri.unit_price AS unitPrice,
            ri.total_price AS totalPrice,
            ri.receipt_item_id AS sort_order
        FROM receipt_items ri
        WHERE ri.receipt_id = #{receiptId}
        ORDER BY ri.receipt_item_id ASC
    </select>

    <select id="selectReceiptItemsByReviewId" parameterType="long" resultType="com.example.LunchGo.review.dto.ReceiptItemResponse">
        SELECT
            ri.menu_name AS name,
            ri.qty AS qty,
            ri.unit_price AS unitPrice,
            ri.total_price AS totalPrice,
            ri.receipt_item_id AS sort_order
        FROM reviews r
        JOIN receipts rc ON rc.receipt_id = r.receipt_id
        JOIN receipt_items ri ON ri.receipt_id = rc.receipt_id
        WHERE r.review_id = #{reviewId}
        UNION ALL
        SELECT
            rmi.menu_name COLLATE utf8mb4_general_ci AS name,
            rmi.quantity AS qty,
            rmi.unit_price AS unitPrice,
            rmi.line_amount AS totalPrice,
            rmi.reservation_menu_item_id AS sort_order
        FROM reviews r
        JOIN reservations rs ON rs.reservation_id = r.reservation_id
        JOIN reservation_menu_items rmi ON rmi.reservation_id = rs.reservation_id
        WHERE r.review_id = #{reviewId}
          AND r.receipt_id IS NULL
        ORDER BY sort_order ASC
    </select>

    <select id="selectReviewTagsByReviewIds" resultType="com.example.LunchGo.review.dto.ReviewTagRow">
        SELECT
            m.review_id AS reviewId,
            t.tag_id AS tagId,
            t.name AS name
        FROM review_tag_maps m
        JOIN review_tags t ON t.tag_id = m.tag_id
        WHERE m.review_id IN
        <foreach collection="reviewIds" item="reviewId" open="(" separator="," close=")">
            #{reviewId}
        </foreach>
        ORDER BY m.review_id, t.tag_id
    </select>

    <select id="selectReviewImagesByReviewIds" resultType="com.example.LunchGo.review.dto.ReviewImageRow">
        SELECT
            review_id AS reviewId,
            image_url AS imageUrl
        FROM review_images
        WHERE review_id IN
        <foreach collection="reviewIds" item="reviewId" open="(" separator="," close=")">
            #{reviewId}
        </foreach>
        ORDER BY review_id, sort_order ASC
    </select>

    <select id="selectAdminReviews" resultType="com.example.LunchGo.review.dto.ReviewAdminItemResponse">
        SELECT
            r.review_id AS reviewId,
            r.restaurant_id AS restaurantId,
            u.name AS reviewerName,
            res.name AS restaurantName,
            r.rating AS rating,
            r.content AS content,
            COALESCE(rc.confirmed_amount, 0) AS totalAmount,
            r.created_at AS createdAt,
            r.status AS status,
            COALESCE(c_count.cnt, 0) AS commentCount,
            r.blind_request_tag_id AS blindRequestTagId,
            brt.name AS blindRequestTagName,
            r.blind_request_reason AS blindRequestReason,
            r.blind_requested_at AS blindRequestedAt
        FROM reviews r
        JOIN users u ON u.user_id = r.user_id
        JOIN restaurants res ON res.restaurant_id = r.restaurant_id
        LEFT JOIN receipts rc ON rc.receipt_id = r.receipt_id
        LEFT JOIN (
            SELECT review_id, COUNT(*) AS cnt
            FROM comments
            GROUP BY review_id
        ) c_count ON c_count.review_id = r.review_id
        LEFT JOIN review_tags brt ON brt.tag_id = r.blind_request_tag_id
        ORDER BY r.created_at DESC
    </select>

</mapper>
