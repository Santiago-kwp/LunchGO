<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.LunchGo.restaurant.mapper.RestaurantSearchMapper">

    <select id="findAvailableRestaurantIds" parameterType="com.example.LunchGo.restaurant.dto.RestaurantSearchParameter" resultType="long">
        SELECT DISTINCT r.restaurant_id
        FROM restaurants r
        -- 지정한 날짜, 시간대, 식당ID로 생성된 예약 슬롯들을 확인(없으면 null)
        LEFT JOIN restaurant_reservation_slots s
            ON r.restaurant_id = s.restaurant_id
            <if test="date != null">
                AND s.slot_date = #{date}
            </if>
            <if test="time != null">
                AND s.slot_time = #{time}
            </if>
        -- 지정한 날짜, 시간대, 식당ID로 생성된 예약 슬롯들을 확인(없으면 null)
        LEFT JOIN (
            -- 지정한 날짜, 시간대에 특정 식당을 예약한 인원수 총합 계산
            SELECT slot_id, COALESCE(SUM(party_size), 0) as total_party_size
            FROM reservations
            WHERE status IN ('TEMPORARY', 'CONFIRMED', 'PREPAID_CONFIRM')
            GROUP BY slot_id
        ) res ON s.slot_id = res.slot_id
        <where>
            AND (
                -- Case 1: 특정 식당에 관한 예약 슬롯이 추가된 적이 없음
                s.slot_id IS NULL
                OR
                -- Case 2: 예약 슬롯이 존재하지만 잔여석이 충분함
                s.max_capacity >= (IFNULL(res.total_party_size, 0) + #{partySize})
            )
        </where>
    </select>

</mapper>