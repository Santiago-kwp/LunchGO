# DB 대소문자 정규화 마이그레이션

이 문서는 테이블명/외래키의 대소문자 정규화를 위한 마이그레이션 실행 방법을 설명합니다.

## 무엇을 하는가

- 대문자 테이블명을 소문자로 변경:
  - `Managers` -> `managers`
  - `Speciality_mappings` -> `speciality_mappings`
  - `Invoice_snapshot` -> `invoice_snapshot`
- 외래키를 소문자 테이블명 기준으로 재생성

`RENAME TABLE`을 사용하므로 데이터는 유지됩니다.

## 실행 시점

테이블명 대소문자 구분이 엄격한 환경(예: Linux, `lower_case_table_names=0`)에서
FK 생성 실패를 방지하기 위해 한 번 실행합니다.

## 실행 방법

```
mysql -u root -p lunchgo < src/main/resources/sql/migration_case_normalization.sql
```

## 참고

- 이 스크립트는 여러 번 실행해도 안전합니다.
- FK 재생성 실패 시, 참조 무결성 위반 데이터를 먼저 정리한 뒤 재시도하세요.

## 환경별 체크리스트

### 스테이징

- [ ] 점검 시간대에 실행
- [ ] 장기 트랜잭션 없음 확인
- [ ] 마이그레이션 SQL 실행
- [ ] FK 무결성 확인 (`SHOW CREATE TABLE`로 핵심 테이블 확인)
- [ ] 스모크 테스트(로그인 + 예약 조회)

### 운영

- [ ] 짧은 점검 시간 확보 및 공지
- [ ] 최신 백업 존재 확인
- [ ] 쓰기 트래픽 중지(또는 유지보수 모드)
- [ ] 마이그레이션 SQL 실행
- [ ] FK 무결성 및 주요 쿼리 확인
- [ ] 트래픽 복구 및 에러 로그 모니터링

## 롤백 기준

- 마이그레이션 직후 핵심 API(로그인/예약 조회/결제 조회)가 실패할 경우
- FK 재생성 실패로 인해 데이터 접근이 불가능한 경우
- 예상치 못한 테이블/컬럼 접근 오류가 다수 발생하는 경우

롤백은 최신 백업을 기준으로 복구하거나, 테이블명을 원복하는 스크립트를 별도 준비해 수행합니다.
