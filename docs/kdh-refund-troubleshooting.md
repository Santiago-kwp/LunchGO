# 환불 트러블슈팅 기록

## 문제 1: 환불 정책과 무관하게 항상 전액 환불 처리됨

### 증상
- 예약 취소 시 시간 조건과 관계없이 항상 100% 환불됨
- 테스트 시 모든 케이스에서 동일 결과 발생

### 원인
- 환불 금액 계산이 프론트 기준으로 처리되고 있었음
- 서버에서는 실제 환불 정책을 적용하지 않음

### 해결
- 환불 비율 계산을 서버 단 로직으로 이동
- 예약 시각과 취소 시각을 비교하여 환불률 계산

### 해결 과정
- 프론트 요청 파라미터만으로 환불 처리되는 구조 확인
- 서버에서 정책을 강제 적용하도록 수정
- 테스트 케이스별 환불 금액 정상 반영 확인


## 문제 2: 점주 취소 시 사용자에게 위약금이 적용되는 문제

### 증상
- 점주가 예약을 취소해도 사용자에게 일부 금액만 환불됨
- 정책과 다른 결과로 사용자 불만 가능성 존재

### 원인
- 사용자 취소와 점주 취소가 동일 로직으로 처리됨
- 취소 주체에 따른 예외 처리가 없음

### 해결
- 점주 취소 시 무조건 100% 환불 처리
- 취소 주체를 기준으로 환불 정책 분기

### 해결 과정
- 점주 취소 시나리오 테스트 중 문제 확인
- 정책 요구사항 재확인 후 분기 로직 추가
- 점주 취소 케이스에서 전액 환불 정상 동작 확인


## 문제 3: 결제 취소 실패 시 예약만 취소되는 불일치

### 증상
- 포트원 결제 취소 실패 상황에서도 예약 상태가 취소됨
- 결제는 유지되었으나 예약은 사라지는 상태 발생

### 원인
- 외부 결제 취소 결과와 무관하게 내부 상태 변경이 먼저 수행됨

### 해결
- 포트원 결제 취소 성공 후에만 예약/결제 상태 변경
- 결제 취소 실패 시 트랜잭션 롤백

### 해결 과정
- 결제 취소 API 실패 로그 확인
- 상태 변경 순서 문제를 확인
- 외부 결제 취소 선행 구조로 수정
